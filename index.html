<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ã‚´ãƒ«ãƒ•ã‚¹ã‚¤ãƒ³ã‚°é£›è·é›¢æ¸¬å®š</title>
</head>
<body>

<h2>ã‚´ãƒ«ãƒ•ã‚¹ã‚¤ãƒ³ã‚°é£›è·é›¢æ¸¬å®šï¼ˆ3å›æ¸¬å®šï¼‰</h2>

<button onclick="requestPermission()">ã‚¹ã‚¤ãƒ³ã‚°é–‹å§‹</button>
<button onclick="stopSensor()">æ¸¬å®šçµ‚äº†</button>
<button onclick="resetAll()">ğŸ”„ ãƒªã‚»ãƒƒãƒˆ</button>

<hr>

<div id="results">ã¾ã æ¸¬å®šã•ã‚Œã¦ã„ã¾ã›ã‚“</div>

<script>
// ============================
// QRã‚³ãƒ¼ãƒ‰èªè¨¼
// ============================
const token = new URLSearchParams(location.search).get("token");
if (token !== "GOLF2026EVENT") {
  document.body.innerHTML = "ç„¡åŠ¹ãªQRã‚³ãƒ¼ãƒ‰ã§ã™";
}

// ============================
// æ¸¬å®šç®¡ç†å¤‰æ•°
// ============================
let maxAccel = 0;
let measurements = [];
let isMeasuring = false;

// ============================
// ã‚»ãƒ³ã‚µãƒ¼è¨±å¯
// ============================
function requestPermission() {
  if (measurements.length >= 3) {
    alert("æ¸¬å®šã¯3å›ã¾ã§ã§ã™ã€‚ãƒªã‚»ãƒƒãƒˆã—ã¦ãã ã•ã„ã€‚");
    return;
  }

  if (typeof DeviceMotionEvent?.requestPermission === "function") {
    DeviceMotionEvent.requestPermission().then(res => {
      if (res === "granted") startSensor();
    });
  } else {
    startSensor();
  }
}

// ============================
// è¨ˆæ¸¬é–‹å§‹
// ============================
function startSensor() {
  maxAccel = 0;
  isMeasuring = true;
  window.addEventListener("devicemotion", handleMotion);
}

// ============================
// ã‚»ãƒ³ã‚µãƒ¼å‡¦ç†
// ============================
function handleMotion(e) {
  if (!isMeasuring) return;

  const a = e.accelerationIncludingGravity;
  if (!a) return;

  const mag = Math.sqrt(a.x*a.x + a.y*a.y + a.z*a.z);
  maxAccel = Math.max(maxAccel, mag);
}

// ============================
// è¨ˆæ¸¬çµ‚äº†
// ============================
function stopSensor() {
  if (!isMeasuring) return;

  isMeasuring = false;
  window.removeEventListener("devicemotion", handleMotion);

  const distance = Math.min(300, Math.max(50, (maxAccel - 10) * 12));
  measurements.push(Math.round(distance));

  updateResults();
}

// ============================
// çµæœè¡¨ç¤º
// ============================
function updateResults() {
  let html = "";

  measurements.forEach((d, i) => {
    html += `<p>ç¬¬${i + 1}å›ï¼š${d} ãƒ¤ãƒ¼ãƒ‰</p>`;
  });

  if (measurements.length === 3) {
    const avg = Math.round(
      measurements.reduce((a, b) => a + b, 0) / 3
    );
    html += `<hr><h3>å¹³å‡é£›è·é›¢ï¼š${avg} ãƒ¤ãƒ¼ãƒ‰</h3>`;
  }

  document.getElementById("results").innerHTML = html;
}

// ============================
// ãƒªã‚»ãƒƒãƒˆå‡¦ç†ï¼ˆâ† è¿½åŠ ãƒ»æ˜ç¢ºåŒ–ï¼‰
// ============================
function resetAll() {
  measurements = [];
  maxAccel = 0;
  isMeasuring = false;

  window.removeEventListener("devicemotion", handleMotion);
  document.getElementById("results").innerHTML =
    "ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸã€‚å†åº¦æ¸¬å®šã§ãã¾ã™ã€‚";
}
</script>

</body>
</html>


